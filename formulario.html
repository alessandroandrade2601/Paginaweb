<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Reserva de Horario</title>
  <style>
    body {
      font-family: Arial;
      max-width:600px;
      margin:2rem auto;
      padding:1rem;
      background:#f9f9f9;
      border-radius:10px;
      box-shadow:0 2px 6px rgba(0,0,0,0.1);
    }
    label { display:block; margin-top:1rem; font-weight:bold; }
    input, select, button { width:100%; padding:0.5rem; margin-top:0.3rem; border:1px solid #ccc; border-radius:6px; }
    button { background:#007bff; color:white; font-size:1rem; cursor:pointer; margin-top:1.5rem; }
    button:hover { background:#0056b3; }
    #plataformaVirtual { display:none; }
  </style>
</head>
<body>
<h2>Formulario de Reserva</h2>
<form id="formReserva">
  <label for="nombre">Nombre completo:</label>
  <input type="text" id="nombre" name="nombre" required>

  <label for="curso">Curso:</label>
  <select id="curso" name="curso" required>
    <option value="" disabled selected>Selecciona un curso</option>
    <option value="Precálculo">Precálculo</option>
    <option value="Cálculo">Cálculo</option>
    <option value="Matemáticas para Sociales">Matemáticas para Sociales</option>
  </select>

  <label for="correo">Correo electrónico:</label>
  <input type="email" id="correo" name="reply_to" required>

  <label for="telefono">Teléfono (WhatsApp):</label>
  <input type="tel" id="telefono" name="telefono" required>

  <label for="modalidad">Modalidad:</label>
  <select id="modalidad" name="modalidad" required>
    <option value="" disabled selected>Selecciona modalidad</option>
    <option value="Presencial">Presencial</option>
    <option value="Virtual">Virtual</option>
  </select>

  <div id="plataformaVirtual">
    <label for="plataforma">Plataforma:</label>
    <select id="plataforma" name="plataforma">
      <option value="" disabled selected>Selecciona una plataforma</option>
      <option value="Zoom">Zoom</option>
      <option value="Discord">Discord</option>
      <option value="Google Meet">Google Meet</option>
    </select>
  </div>

  <label for="fecha">Fecha de la clase:</label>
  <select id="fecha" name="fecha" required>
    <option value="" disabled selected>Selecciona una fecha</option>
  </select>

  <label for="cantidadHoras">Cantidad de horas a estudiar:</label>
  <select id="cantidadHoras" name="cantidadHoras" required>
    <option value="" disabled selected>Selecciona cantidad de horas</option>
    <option value="1">1 hora</option>
    <option value="2">2 horas</option>
    <option value="3">3 horas</option>
  </select>

  <label for="hora">Horario:</label>
  <select id="hora" name="hora" required>
    <option value="" disabled selected>Selecciona una hora</option>
  </select>

  <p id="precioInfo" style="font-weight:bold; margin-top:10px;"></p>

  <button type="submit">Confirmar Reserva</button>
</form>

<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="horario.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    inicializarHorarios('fecha', 'hora', 'cantidadHoras');
  });

  // Mostrar/ocultar plataforma virtual
  document.getElementById("modalidad").addEventListener("change", function() {
    const plataformaDiv = document.getElementById("plataformaVirtual");
    if(this.value === "Virtual"){
      plataformaDiv.style.display="block";
      document.getElementById("plataforma").setAttribute("required","true");
    } else {
      plataformaDiv.style.display="none";
      document.getElementById("plataforma").removeAttribute("required");
    }
  });

  // Configuración EmailJS
  (function(){emailjs.init("vr65LudGmqM4lx7Bb");})();

  // --- Envío de formulario ---
  document.getElementById('formReserva').addEventListener('submit', async function(e){
    e.preventDefault();
    const form = this;

    const precioTexto = document.getElementById('precioInfo').textContent;
    if(!precioTexto) {
      Swal.fire({icon:'warning', title:'Selecciona fecha, hora y cantidad de horas', text:'Debes ver el precio antes de confirmar.'});
      return;
    }

    const datos = {
      nombre: form.nombre.value,
      correo: form.correo.value,
      telefono: form.telefono.value,
      curso: form.curso.value,
      modalidad: form.modalidad.value,
      plataforma: form.plataforma.value,
      cantidadHoras: Number(form.cantidadHoras.value),
      fecha: form.fecha.value,
      hora: form.hora.value
    };

    try {
      const resp = await fetch('http://localhost:3000/reservas', {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify(datos)
      });
      const data = await resp.json();

      await emailjs.sendForm('service_idxbf5h','template_9212lnw',form);
      await emailjs.sendForm('service_idxbf5h','template_vq0rs6j',form);

      Swal.fire({icon:'success', title:'¡Reserva enviada!', text:`Tu reserva ha sido registrada. Precio: S/. ${data.precio}`, confirmButtonText:'Entendido'});
      form.reset();
      document.getElementById("plataformaVirtual").style.display="none";
      document.getElementById('precioInfo').textContent = '';

      // Actualizar horarios
      if(form.fecha.value && form.cantidadHoras.value){
        const event = new Event('change');
        document.getElementById('fecha').dispatchEvent(event);
      }
    } catch(err) {
      console.error(err);
      Swal.fire({icon:'error', title:'Oops...', text:'Hubo un problema al registrar tu reserva. Intenta nuevamente.'});
    }
  });

  // Actualizar horarios cada 30s automáticamente
  setInterval(() => {
    const fechaVal = document.getElementById('fecha').value;
    const cantHorasVal = document.getElementById('cantidadHoras').value;
    if(fechaVal && cantHorasVal){
      const event = new Event('change');
      document.getElementById('fecha').dispatchEvent(event);
    }
  }, 30000);
</script>
</body>
</html>

